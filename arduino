#include <SPI.h>
#include <Ethernet.h>

// ============ ETHERNET ============
byte mac[] = {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED};
IPAddress ip(192, 168, 0, 50);
IPAddress gateway(192, 168, 0, 1);
IPAddress subnet(255, 255, 255, 0);
EthernetServer server(502);

// ============ SENSORS ============
#define TRIG_BALL 2    // Measures ball height
#define ECHO_BALL 3
#define TRIG_REF 4     // Measures reference point
#define ECHO_REF 5

// ============ OUTPUTS ============
#define FAN_PWM 9      // Fan speed from PLC (0-255)
#define HEARTBEAT_LED 7

// ============ DATA ============
uint16_t ballHeight = 0;       // From Sensor 1
uint16_t referenceHeight = 0;  // From Sensor 2 (setpoint reference)
uint16_t fanSpeed = 0;         // From PLC (0-255)
bool systemEnable = true;      // From PLC
uint16_t heartbeat = 0;        // Incrementing counter

void setup() {
  Serial.begin(115200);
  while (!Serial) {
    ; // wait
  }
  
  Serial.println("=== BALL LEVITATION ===");
  Serial.println("Arduino: Sensors + PWM Executor");
  Serial.println("PLC: PID Control");
  
  // Ethernet Shield 2
  Ethernet.init(10);  // CS pin = 10
  Ethernet.begin(mac, ip, gateway, gateway, subnet);
  delay(2000);
  server.begin();
  
  Serial.print("IP: ");
  Serial.println(Ethernet.localIP());
  
  // Pins
  pinMode(TRIG_BALL, OUTPUT);
  pinMode(ECHO_BALL, INPUT);
  pinMode(TRIG_REF, OUTPUT);
  pinMode(ECHO_REF, INPUT);
  pinMode(FAN_PWM, OUTPUT);
  pinMode(HEARTBEAT_LED, OUTPUT);
  pinMode(LED_BUILTIN, OUTPUT);
  
  analogWrite(FAN_PWM, 0);  // Start with fan off
  
  Serial.println("Ready - Waiting for PLC commands");
  Serial.println("----------------------");
}

void loop() {
  static unsigned long lastSensor = 0;
  static unsigned long lastHeartbeat = 0;
  static unsigned long lastPrint = 0;
  
  unsigned long now = millis();
  
  // 1. Read sensors every 50ms
  if (now - lastSensor > 50) {
    ballHeight = readSensor(TRIG_BALL, ECHO_BALL);
    referenceHeight = readSensor(TRIG_REF, ECHO_REF);
    lastSensor = now;
  }
  
  // 2. Heartbeat LED every 500ms
  if (now - lastHeartbeat > 500) {
    heartbeat++;
    digitalWrite(HEARTBEAT_LED, heartbeat % 2);
    digitalWrite(LED_BUILTIN, heartbeat % 2);
    lastHeartbeat = now;
  }
  
  // 3. Control fan with PWM from PLC
  analogWrite(FAN_PWM, systemEnable ? fanSpeed : 0);
  
  // 4. Print status every second
  if (now - lastPrint > 1000) {
    Serial.print("Ball: ");
    Serial.print(ballHeight);
    Serial.print("mm, Ref: ");
    Serial.print(referenceHeight);
    Serial.print("mm, Fan PWM: ");
    Serial.println(fanSpeed);
    lastPrint = now;
  }
  
  // 5. Handle Modbus requests from PLC
  EthernetClient client = server.available();
  if (client) {
    handleModbus(client);
  }
  
  delay(10);
}

// ============ ULTRASONIC ============
uint16_t readSensor(int trig, int echo) {
  digitalWrite(trig, LOW);
  delayMicroseconds(2);
  digitalWrite(trig, HIGH);
  delayMicroseconds(10);
  digitalWrite(trig, LOW);
  
  long duration = pulseIn(echo, HIGH, 30000);
  if (duration <= 0) return 0;
  return (uint16_t)(duration * 0.017); // Î¼s to mm
}

// ============ MODBUS TCP ============
void handleModbus(EthernetClient &client) {
  if (client.available() < 12) return;
  
  byte request[12];
  for (int i = 0; i < 12; i++) {
    request[i] = client.read();
  }
  
  byte func = request[7];
  uint16_t addr = (request[8] << 8) | request[9];
  uint16_t qty = (request[10] << 8) | request[11];
  
  if (func == 0x03) { // READ HOLDING REGISTERS (PLC reading from Arduino)
    
    // Only send 5 registers max
    if (qty > 5) qty = 5;
    
    byte response[9 + qty * 2];
    
    // Header
    response[0] = request[0];
    response[1] = request[1];
    response[2] = 0x00;
    response[3] = 0x00;
    response[4] = 0x00;
    response[5] = 3 + qty * 2;
    response[6] = 0xFF; // Unit ID
    response[7] = 0x03;
    response[8] = qty * 2;
    
    // Data: ballHeight, referenceHeight, fanSpeed, heartbeat, systemEnable
    for (int i = 0; i < qty; i++) {
      uint16_t value = 0;
      switch(i) {
        case 0: value = ballHeight; break;
        case 1: value = referenceHeight; break;
        case 2: value = fanSpeed; break;
        case 3: value = heartbeat; break;
        case 4: value = systemEnable ? 1 : 0; break;
      }
      response[9 + i*2] = value >> 8;
      response[10 + i*2] = value & 0xFF;
    }
    
    client.write(response, 9 + qty * 2);
    
  } else if (func == 0x06) { // WRITE SINGLE REGISTER (PLC writing to Arduino)
    uint16_t value = (request[10] << 8) | request[11];
    
    // Address mapping:
    // 40003 = Fan speed PWM (0-255) from PLC PID
    // 40005 = System enable/disable
    if (addr == 2) { // 40003
      fanSpeed = min(value, 255);
      Serial.print("PLC PID -> Fan PWM: ");
      Serial.println(fanSpeed);
    } else if (addr == 4) { // 40005
      systemEnable = (value > 0);
      Serial.print("System ");
      Serial.println(systemEnable ? "ENABLED" : "DISABLED");
    }
    
    // Echo back to PLC
    client.write(request, 12);
  }
  
  client.stop();
}
